<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Advic KPI Deviation App</title>
  <script src="ClientGlobalContext.js.aspx" type="text/javascript"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f4f6f9;
      padding: 30px;
      color: #333;
    }
    .container {
      max-width: 600px;
      margin: auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      padding: 30px;
      text-align: center;
    }
    h2 {
      color: #2c3e50;
      margin-bottom: 25px;
    }
    label {
      display: block;
      margin-bottom: 12px;
      font-weight: 600;
      text-align: left;
    }
    textarea {
      width: 100%;
      padding: 10px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 8px;
      resize: vertical;
    }
    .checkbox-container {
      margin: 20px 0;
      text-align: left;
    }
    input[type="checkbox"] {
      transform: scale(1.2);
      margin-right: 10px;
    }
    button {
      background-color: #0078d4;
      color: white;
      padding: 12px 20px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      width: 100%;
    }
    button:hover {
      background-color: #005a9e;
    }
  </style>
</head>
<body>
  <div class="container" id="mainContainer">
    <!-- Form will be injected here by JS if not acknowledged -->
  </div>

  <script>
    window.onload = async function () {
      const id = new URLSearchParams(window.location.search).get("id");
      const container = document.getElementById("mainContainer");

      if (!id) {
        container.innerHTML = `<h2>❌ Invalid Link</h2><p>No KPI Deviation ID found in URL.</p>`;
        return;
      }

      try {
        const req = new XMLHttpRequest();
        req.open("GET", Xrm.Utility.getGlobalContext().getClientUrl() + `/api/data/v9.2/advic_kpideviationlogs(${id})?$select=advic_acknowledged`, false);
        req.setRequestHeader("OData-MaxVersion", "4.0");
        req.setRequestHeader("OData-Version", "4.0");
        req.setRequestHeader("Accept", "application/json");
        req.setRequestHeader("Content-Type", "application/json; charset=utf-8");
        req.send();

        if (req.status === 200) {
          const response = JSON.parse(req.responseText);
          if (response.advic_acknowledged) {
            container.innerHTML = `
              <h2>✅ Already Acknowledged</h2>
              <p>This KPI Deviation has already been submitted.</p>
            `;
          } else {
            container.innerHTML = `
              <h2>KPI Deviation Acknowledgement</h2>
              <form onsubmit="submitAcknowledgement(); return false;">
                <div class="checkbox-container">
                  <label>
                    <input type="checkbox" id="ack" />
                    I Acknowledge this deviation
                  </label>
                </div>
                <label for="reason">Reason for Deviation:</label>
                <textarea id="reason" rows="5" placeholder="Please mention the reason for the deviation..."></textarea>
                <br /><br />
                <button type="submit">Submit Acknowledgement</button>
              </form>
            `;
          }
        } else {
          container.innerHTML = `<h2>❌ Error</h2><p>Unable to verify the deviation record.</p>`;
        }
      } catch (e) {
        container.innerHTML = `<h2>❌ Unexpected Error</h2><p>${e.message}</p>`;
      }
    };

    async function submitAcknowledgement() {
      const id = new URLSearchParams(window.location.search).get("id");
      const reason = document.getElementById("reason").value;
      const acknowledged = document.getElementById("ack").checked;

      if (!id) {
        alert("No KPI Deviation ID found in URL.");
        return;
      }

      if (!acknowledged) {
        alert("Please check the Acknowledgement box.");
        return;
      }

      const acknowledgedOn = new Date().toISOString();
      const body = {
        advic_acknowledged: true,
        advic_acknowledgedon: acknowledgedOn,
        advic_deviationreason: reason
      };

      try {
        const req = new XMLHttpRequest();
        req.open("PATCH", Xrm.Utility.getGlobalContext().getClientUrl() + `/api/data/v9.2/advic_kpideviationlogs(${id})`, true);
        req.setRequestHeader("OData-MaxVersion", "4.0");
        req.setRequestHeader("OData-Version", "4.0");
        req.setRequestHeader("Accept", "application/json");
        req.setRequestHeader("Content-Type", "application/json; charset=utf-8");
        req.setRequestHeader("Prefer", "return=representation");

        req.onreadystatechange = function () {
          if (this.readyState === 4) {
            req.onreadystatechange = null;
            if (this.status === 204 || this.status === 200) {
              document.body.innerHTML = `
                <div class="container">
                  <h2>✅ Thank You!</h2>
                  <p>Your KPI Deviation has been acknowledged successfully.</p>
                </div>
              `;
              setTimeout(() => window.close(), 1500);
            } else {
              console.error(this.responseText);
              alert("Error while submitting.");
            }
          }
        };
        req.send(JSON.stringify(body));
      } catch (e) {
        alert("Unexpected error: " + e.message);
      }
    }
  </script>
</body>
</html>
